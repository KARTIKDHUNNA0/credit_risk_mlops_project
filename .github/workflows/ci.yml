name: Credit Risk CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        # Install core project dependencies
        pip install -r requirements.txt
        # Install test dependencies
        pip install pytest httpx scikit-learn joblib numpy pandas

    # ðŸš¨ CRITICAL FIX: Create Dummy Model AND Dummy Data
    # This satisfies BOTH joblib.load calls in src/api/model.py
    - name: Create Placeholders (Model + Data)
      run: |
        # Create directories
        mkdir -p models
        mkdir -p data/processed
        
        # Generate dummy artifacts using Python
        python - << 'EOF'
        import joblib
        import numpy as np
        import pandas as pd
        from sklearn.dummy import DummyClassifier

        # --- 1. Create Dummy Model ---
        model = DummyClassifier(strategy='prior')
        X_train = np.array([[0], [0]])
        y_train = np.array([0, 1])
        model.fit(X_train, y_train)
        joblib.dump(model, "models/best_model_lgbm.pkl")
        print("Created dummy model.")

        # --- 2. Create Dummy Training Data ---
        # The API loads this to get column names. 
        # We create a simple DataFrame with a generic feature and TARGET.
        df = pd.DataFrame({
            "feature_1": [0.1, 0.2, 0.3],
            "feature_2": [1, 0, 1],
            "TARGET": [0, 1, 0]
        })
        # Dump it to the path expected by your API (data/processed/)
        joblib.dump(df, "data/processed/train_FINAL.pkl")
        print("Created dummy training data.")
        EOF

    # 4. Setup PYTHONPATH
    - name: Add project root to Python path
      run: echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

    # 5. Run API Tests
    - name: Run FastAPI Smoke Tests
      run: |
        pytest tests/test_api.py

    # 6. Dry Run Prefect Pipeline Logic
    - name: Dry Run Train Flow Logic
      run: |
        python src/pipelines/train_flow.py
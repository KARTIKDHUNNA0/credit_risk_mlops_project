name: Credit Risk CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        # Install core project dependencies
        pip install -r requirements.txt
        # Install test dependencies
        pip install pytest httpx scikit-learn joblib numpy pandas

    # ðŸš¨ CRITICAL FIX: Use Standard Sklearn Dummy Classifier
    # Using a standard library class prevents "AttributeError: Can't get attribute..." 
    # because pickle can find 'sklearn.dummy.DummyClassifier' globally.
    - name: Create Placeholder Model (Bypass File Not Found Error)
      run: |
        mkdir -p models
        python - << 'EOF'
        import joblib
        import numpy as np
        from sklearn.dummy import DummyClassifier

        # Initialize a standard DummyClassifier
        # We use strategy='prior' so it predicts based on class distribution
        model = DummyClassifier(strategy='prior')

        # Fit on dummy data with both class 0 and class 1
        # This ensures model.predict_proba returns 2 columns (Prob_0, Prob_1)
        X_train = np.array([[0], [0]])
        y_train = np.array([0, 1])
        model.fit(X_train, y_train)

        # Dump the model
        joblib.dump(model, "models/best_model_lgbm.pkl")
        print("Created sklearn.dummy model for CI/CD.")
        EOF

    # 4. Setup PYTHONPATH
    - name: Add project root to Python path
      run: echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

    # 5. Run API Tests
    - name: Run FastAPI Smoke Tests
      run: |
        pytest tests/test_api.py

    # 6. Dry Run Prefect Pipeline Logic
    - name: Dry Run Train Flow Logic
      run: |
        python src/pipelines/train_flow.py